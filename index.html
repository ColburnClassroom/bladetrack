<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BladeTrack Pro: Food & Blading Tracker</title>
<style>
  body { font-family: Arial,sans-serif; max-width: 700px; margin: auto; padding: 20px; }
  h1,h2 { text-align: center; }
  label, button { display: block; margin: 10px 0 5px; }
  input[type=number], select { width: 100%; padding: 8px; font-size: 16px; }
  button { background:#1976d2; color:#fff; border:none; padding:12px; cursor:pointer; border-radius:4px; }
  button:disabled { background:#999; cursor:not-allowed; }
  #map { height: 300px; margin-top: 10px; border:1px solid #ccc; }
  table { width: 100%; border-collapse: collapse; margin-top:10px; }
  th,td { border: 1px solid #ccc; padding: 6px; text-align: center; font-size: 14px; }
  th { background:#f0f0f0; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>

<h1>BladeTrack Pro</h1>

<section id="calorie-planner">
  <h2>Daily Calorie Target & Meal Distribution</h2>
  <label for="dailyCal">Set your daily calorie goal (kcal):</label>
  <input type="number" id="dailyCal" min="800" max="5000" value="2000" />

  <label>Adjust meal calorie % (must sum to 100%)</label>
  <label>Breakfast %:
    <input type="number" id="pctBreakfast" min="0" max="100" value="25" />
  </label>
  <label>Lunch %:
    <input type="number" id="pctLunch" min="0" max="100" value="35" />
  </label>
  <label>Dinner %:
    <input type="number" id="pctDinner" min="0" max="100" value="40" />
  </label>
  <p id="pctError" style="color:red; display:none;">Percentages must add to 100%</p>
  <button onclick="updateMealTargets()">Update Meal Targets</button>

  <div id="mealTargets" style="margin-top:15px;">
    <p>Breakfast target: <span id="breakfastTarget"></span> kcal</p>
    <p>Lunch target: <span id="lunchTarget"></span> kcal</p>
    <p>Dinner target: <span id="dinnerTarget"></span> kcal</p>
  </div>
</section>

<section id="food-logging" style="margin-top:40px;">
  <h2>Log Your Meals</h2>
  <p>Choose foods to log for each meal (high-protein, low-carb list):</p>

  <div>
    <h3>Breakfast</h3>
    <div id="breakfastFoods"></div>
  </div>
  <div>
    <h3>Lunch</h3>
    <div id="lunchFoods"></div>
  </div>
  <div>
    <h3>Dinner</h3>
    <div id="dinnerFoods"></div>
  </div>

  <button onclick="saveFoodLog()">Save Daily Food Log</button>

  <div id="foodLogSummary" style="margin-top:20px;"></div>
</section>

<section id="rollerblading-tracker" style="margin-top:40px;">
  <h2>Rollerblading GPS Tracker</h2>
  <button id="startTrackBtn" onclick="startTracking()">Start Session</button>
  <button id="stopTrackBtn" onclick="stopTracking()" disabled>Stop Session</button>
  <p id="sessionInfo"></p>
  <div id="map"></div>
</section>

<section id="electrolyte-advice" style="margin-top:40px;">
  <h2>Electrolyte & Temperature Advice</h2>
  <p id="electrolyteText"></p>
</section>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // --- Food data (high-protein, low-carb) ---
  const foodDB = [
    { name: "Grilled Chicken Breast (3 oz)", calories: 140, protein: 26, carbs: 0, fat: 3 },
    { name: "Salmon (3 oz)", calories: 175, protein: 19, carbs: 0, fat: 10 },
    { name: "Tofu (100g)", calories: 70, protein: 8, carbs: 2, fat: 4 },
    { name: "Avocado (1/2 medium)", calories: 120, protein: 1, carbs: 6, fat: 11 },
    { name: "Egg (1 large)", calories: 70, protein: 6, carbs: 0, fat: 5 },
    { name: "Almonds (1 oz)", calories: 160, protein: 6, carbs: 6, fat: 14 },
    { name: "Broccoli (1 cup)", calories: 55, protein: 4, carbs: 11, fat: 1 },
    { name: "Greek Yogurt (plain, 6 oz)", calories: 100, protein: 17, carbs: 6, fat: 0 },
    { name: "Spinach (1 cup)", calories: 7, protein: 1, carbs: 1, fat: 0 },
  ];

  // --- Meal calorie targets ---
  let dailyCal = 2000;
  let mealPercents = { breakfast: 25, lunch: 35, dinner: 40 };

  function updateMealTargets() {
    const b = Number(document.getElementById('pctBreakfast').value);
    const l = Number(document.getElementById('pctLunch').value);
    const d = Number(document.getElementById('pctDinner').value);
    const total = b + l + d;
    const pctError = document.getElementById('pctError');
    if(total !== 100) {
      pctError.style.display = 'block';
      return;
    }
    pctError.style.display = 'none';
    dailyCal = Number(document.getElementById('dailyCal').value) || 2000;
    mealPercents = { breakfast: b, lunch: l, dinner: d };
    document.getElementById('breakfastTarget').textContent = Math.round(dailyCal * b/100);
    document.getElementById('lunchTarget').textContent = Math.round(dailyCal * l/100);
    document.getElementById('dinnerTarget').textContent = Math.round(dailyCal * d/100);
  }
  updateMealTargets();

  // --- Food logging UI ---
  function createFoodCheckboxes(containerId) {
    const container = document.getElementById(containerId);
    foodDB.forEach((food, i) => {
      const div = document.createElement('div');
      div.innerHTML = `
        <label>
          <input type="checkbox" data-index="${i}" data-meal="${containerId}" />
          ${food.name} — ${food.calories} kcal, P:${food.protein}g C:${food.carbs}g F:${food.fat}g
        </label>
      `;
      container.appendChild(div);
    });
  }

  createFoodCheckboxes('breakfastFoods');
  createFoodCheckboxes('lunchFoods');
  createFoodCheckboxes('dinnerFoods');

  function saveFoodLog() {
    const log = {
      date: new Date().toISOString().slice(0,10),
      meals: { breakfast: [], lunch: [], dinner: [] },
      totals: { calories: 0, protein: 0, carbs: 0, fat: 0 }
    };
    ['breakfastFoods', 'lunchFoods', 'dinnerFoods'].forEach(mealId => {
      const meal = mealId.replace('Foods','');
      const checkboxes = document.querySelectorAll(`#${mealId} input[type=checkbox]`);
      checkboxes.forEach(cb => {
        if(cb.checked) {
          const food = foodDB[cb.dataset.index];
          log.meals[meal].push(food);
          log.totals.calories += food.calories;
          log.totals.protein += food.protein;
          log.totals.carbs += food.carbs;
          log.totals.fat += food.fat;
        }
      });
    });
    localStorage.setItem('bladeTrackFoodLog', JSON.stringify(log));
    displayFoodLogSummary(log);
    alert('Food log saved!');
  }

  function displayFoodLogSummary(log) {
    const container = document.getElementById('foodLogSummary');
    let html = `<h3>Today's Food Log Summary</h3>`;
    html += `<p>Total Calories: ${log.totals.calories} kcal</p>`;
    html += `<p>Protein: ${log.totals.protein} g, Carbs: ${log.totals.carbs} g, Fat: ${log.totals.fat} g</p>`;
    container.innerHTML = html;
  }

  // Show saved food log on load
  const savedFoodLog = localStorage.getItem('bladeTrackFoodLog');
  if(savedFoodLog) {
    displayFoodLogSummary(JSON.parse(savedFoodLog));
  }

  // --- Rollerblading GPS Tracker ---
  let map, polyline, watchId;
  let positions = [];
  let startTime, endTime;

  function initMap() {
    map = L.map('map').setView([40.7359, -73.9911], 13); // Union Square NYC
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    polyline = L.polyline([], { color: 'blue' }).addTo(map);
  }

  function startTracking() {
    if(!navigator.geolocation) {
      alert('Geolocation not supported by your browser');
      return;
    }
    positions = [];
    polyline.setLatLngs([]);
    startTime = new Date();
    watchId = navigator.geolocation.watchPosition(onPosition, onError, {
      enableHighAccuracy: true,
      maximumAge: 1000,
      timeout: 10000
    });
    document.getElementById('startTrackBtn').disabled = true;
    document.getElementById('stopTrackBtn').disabled = false;
    document.getElementById('sessionInfo').textContent = 'Tracking started...';
  }

  function onPosition(position) {
    const latlng = [position.coords.latitude, position.coords.longitude];
    positions.push(latlng);
    polyline.addLatLng(latlng);
    map.panTo(latlng);
  }

  function onError(err) {
    alert('Geolocation error: ' + err.message);
  }

  function stopTracking() {
    if(watchId) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
      endTime = new Date();
      document.getElementById('startTrackBtn').disabled = false;
      document.getElementById('stopTrackBtn').disabled = true;
      calculateSession();
    }
  }

  function calculateDistance() {
    let distance = 0;
    for(let i=1; i<positions.length; i++) {
      distance += getDistanceFromLatLonInMiles(positions[i-1], positions[i]);
    }
    return distance;
  }

  // Haversine formula to calculate miles between two lat/lon points
  function getDistanceFromLatLonInMiles(latlng1, latlng2) {
    const R = 3958.8; // Radius of the earth in miles
    const dLat = deg2rad(latlng2[0]-latlng1[0]);
    const dLon = deg2rad(latlng2[1]-latlng1[1]);
    const a =
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(deg2rad(latlng1[0])) * Math.cos(deg2rad(latlng2[0])) *
      Math.sin(dLon/2) * Math.sin(dLon/2)
      ;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }
  function deg2rad(deg) {
    return deg * (Math.PI/180);
  }

  function calculateSession() {
    if(positions.length < 2) {
      document.getElementById('sessionInfo').textContent = 'Not enough data points tracked.';
      return;
    }
    const dist = calculateDistance();
    const durationMin = (endTime - startTime) / 60000;
    const mph = dist / (durationMin / 60);

    // Calculate calories burned based on weight and duration, MET 7.0 rollerblading
    const weightLbs = Number(document.getElementById('dailyCal').value) || 160; // fallback weight 160 lbs
    const weightKg = weightLbs * 0.453592;
    const caloriesBurned = 7.0 * weightKg * (durationMin / 60);

    document.getElementById('sessionInfo').textContent =
      `Session complete: ${dist.toFixed(2)} miles, ${durationMin.toFixed(1)} minutes, Avg speed ${mph.toFixed(2)} mph, Estimated calories burned: ${caloriesBurned.toFixed(0)} kcal.`;

    // Save session to localStorage
    let sessions = JSON.parse(localStorage.getItem('bladeTrackSessions') || '[]');
    sessions.unshift({
      date: new Date().toISOString(),
      distance: dist,
      duration: durationMin,
      avgSpeed: mph,
      calories: caloriesBurned,
      route: positions
    });
    localStorage.setItem('bladeTrackSessions', JSON.stringify(sessions));
  }

  // --- Electrolyte & Temp Advice ---
  function getElectrolyteAdvice(tempF, isBlading, duration) {
    if(tempF > 86 || (isBlading && duration >= 45)) {
      return "🔥 Hot or long session.\nUse LMNT or broth for real sodium replacement.\nEat potassium-rich foods like bananas, avocado.\nDon’t trust Smartwater alone — it won’t replace lost electrolytes.\nMagnesium from nuts/seeds helps recovery.\nStay hydrated but avoid overhydration without electrolytes.";
    }
    if(isBlading) {
      return "Moderate conditions.\nStay hydrated and eat potassium-rich foods (bananas, avocado).\nMagnesium-rich nuts/seeds support recovery.";
    }
    return "Rest day.\nMaintain hydration and balanced diet with natural electrolytes.\nConsider salty snacks or broth if you sweat indoors or in heat.";
  }

  // Show electrolyte advice based on dummy inputs for demo
  function updateElectrolyteAdvice() {
    const tempF = Number(document.getElementById('dailyCal').value) > 0 ? 89.6 : 70; // Placeholder
    const isBlading = true; // For demo
    const duration = 60; // For demo
    document.getElementById('electrolyteText').textContent = getElectrolyteAdvice(tempF, isBlading, duration);
  }
  updateElectrolyteAdvice();

  // Initialize Leaflet map
  initMap();

</script>
</body>
</html>
